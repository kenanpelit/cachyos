#!/usr/bin/env bash
set -euo pipefail

if ! command -v hblock >/dev/null 2>&1; then
  echo "hblock not found in PATH" >&2
  exit 1
fi

SUDO=""
if [ "$(id -u)" -ne 0 ]; then
  if ! command -v sudo >/dev/null 2>&1; then
    echo "sudo is required to update /etc/hosts" >&2
    exit 1
  fi
  SUDO="sudo"
fi

HOSTS_FILE="/etc/hosts"
BLOCK_BEGIN="# hblock-start"
BLOCK_END="# hblock-end"
TEMP_FILE="$(mktemp)"

if [ -f "${HOSTS_FILE}" ]; then
  ${SUDO} awk -v begin="${BLOCK_BEGIN}" -v end="${BLOCK_END}" '
    $0 == begin {skip=1; next}
    $0 == end {skip=0; next}
    skip != 1 {print}
  ' "${HOSTS_FILE}" > "${TEMP_FILE}"
else
  : > "${TEMP_FILE}"
fi

{
  echo ""
  echo "${BLOCK_BEGIN}"
  hblock -O - 2>/dev/null
  echo "${BLOCK_END}"
} >> "${TEMP_FILE}"

${SUDO} install -m 644 "${TEMP_FILE}" "${HOSTS_FILE}"
rm -f "${TEMP_FILE}"
